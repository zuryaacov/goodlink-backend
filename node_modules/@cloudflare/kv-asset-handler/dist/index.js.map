{"version":3,"sources":["../src/types.ts","../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["declare global {\n\tconst __STATIC_CONTENT: KVNamespace | undefined;\n\tconst __STATIC_CONTENT_MANIFEST: Record<string, string> | undefined;\n}\n\nexport type CacheControl = {\n\tbrowserTTL: number;\n\tedgeTTL: number;\n\tbypassCache: boolean;\n};\n\nexport type AssetManifestType = Record<string, string>;\n\nexport type Options = {\n\tcacheControl:\n\t\t| ((req: Request) => Partial<CacheControl>)\n\t\t| Partial<CacheControl>;\n\tASSET_NAMESPACE: KVNamespace;\n\tASSET_MANIFEST: AssetManifestType | string;\n\tmapRequestToAsset?: (req: Request, options?: Partial<Options>) => Request;\n\tdefaultMimeType: string;\n\tdefaultDocument: string;\n\tpathIsEncoded: boolean;\n\tdefaultETag: \"strong\" | \"weak\";\n};\n\nexport class KVError extends Error {\n\tconstructor(message?: string, status: number = 500) {\n\t\tsuper(message);\n\t\t// see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n\t\tObject.setPrototypeOf(this, new.target.prototype); // restore prototype chain\n\t\tthis.name = KVError.name; // stack traces display correctly now\n\t\tthis.status = status;\n\t}\n\tstatus: number;\n}\nexport class MethodNotAllowedError extends KVError {\n\tconstructor(\n\t\tmessage: string = `Not a valid request method`,\n\t\tstatus: number = 405\n\t) {\n\t\tsuper(message, status);\n\t}\n}\nexport class NotFoundError extends KVError {\n\tconstructor(message: string = `Not Found`, status: number = 404) {\n\t\tsuper(message, status);\n\t}\n}\nexport class InternalError extends KVError {\n\tconstructor(\n\t\tmessage: string = `Internal Error in KV Asset Handler`,\n\t\tstatus: number = 500\n\t) {\n\t\tsuper(message, status);\n\t}\n}\n","import * as mime from \"mime\";\nimport {\n\tCacheControl,\n\tInternalError,\n\tMethodNotAllowedError,\n\tNotFoundError,\n\tOptions,\n} from \"./types\";\nimport type { AssetManifestType } from \"./types\";\n\nconst defaultCacheControl: CacheControl = {\n\tbrowserTTL: null,\n\tedgeTTL: 2 * 60 * 60 * 24, // 2 days\n\tbypassCache: false, // do not bypass Cloudflare's cache\n};\n\nconst parseStringAsObject = <T>(maybeString: string | T): T =>\n\ttypeof maybeString === \"string\"\n\t\t? (JSON.parse(maybeString) as T)\n\t\t: maybeString;\n\nfunction getAssetFromKVDefaultOptions(): Partial<Options> {\n\treturn {\n\t\tASSET_NAMESPACE:\n\t\t\ttypeof __STATIC_CONTENT !== \"undefined\" ? __STATIC_CONTENT : undefined,\n\t\tASSET_MANIFEST:\n\t\t\ttypeof __STATIC_CONTENT_MANIFEST !== \"undefined\"\n\t\t\t\t? parseStringAsObject<AssetManifestType>(__STATIC_CONTENT_MANIFEST)\n\t\t\t\t: {},\n\t\tcacheControl: defaultCacheControl,\n\t\tdefaultMimeType: \"text/plain\",\n\t\tdefaultDocument: \"index.html\",\n\t\tpathIsEncoded: false,\n\t\tdefaultETag: \"strong\",\n\t};\n}\n\nfunction assignOptions(options?: Partial<Options>): Options {\n\t// Assign any missing options passed in to the default\n\t// options.mapRequestToAsset is handled manually later\n\treturn <Options>Object.assign({}, getAssetFromKVDefaultOptions(), options);\n}\n\n/**\n * maps the path of incoming request to the request pathKey to look up\n * in bucket and in cache\n * e.g.  for a path '/' returns '/index.html' which serves\n * the content of bucket/index.html\n * @param {Request} request incoming request\n */\nconst mapRequestToAsset = (request: Request, options?: Partial<Options>) => {\n\toptions = assignOptions(options);\n\n\tconst parsedUrl = new URL(request.url);\n\tlet pathname = parsedUrl.pathname;\n\n\tif (pathname.endsWith(\"/\")) {\n\t\t// If path looks like a directory append options.defaultDocument\n\t\t// e.g. If path is /about/ -> /about/index.html\n\t\tpathname = pathname.concat(options.defaultDocument);\n\t} else if (!mime.getType(pathname)) {\n\t\t// If path doesn't look like valid content\n\t\t//  e.g. /about.me ->  /about.me/index.html\n\t\tpathname = pathname.concat(\"/\" + options.defaultDocument);\n\t}\n\n\tparsedUrl.pathname = pathname;\n\treturn new Request(parsedUrl.toString(), request);\n};\n\n/**\n * maps the path of incoming request to /index.html if it evaluates to\n * any HTML file.\n * @param {Request} request incoming request\n */\nfunction serveSinglePageApp(\n\trequest: Request,\n\toptions?: Partial<Options>\n): Request {\n\toptions = assignOptions(options);\n\n\t// First apply the default handler, which already has logic to detect\n\t// paths that should map to HTML files.\n\trequest = mapRequestToAsset(request, options);\n\n\tconst parsedUrl = new URL(request.url);\n\n\t// Detect if the default handler decided to map to\n\t// a HTML file in some specific directory.\n\tif (parsedUrl.pathname.endsWith(\".html\")) {\n\t\t// If expected HTML file was missing, just return the root index.html (or options.defaultDocument)\n\t\treturn new Request(\n\t\t\t`${parsedUrl.origin}/${options.defaultDocument}`,\n\t\t\trequest\n\t\t);\n\t} else {\n\t\t// The default handler decided this is not an HTML page. It's probably\n\t\t// an image, CSS, or JS file. Leave it as-is.\n\t\treturn request;\n\t}\n}\n\n/**\n * takes the path of the incoming request, gathers the appropriate content from KV, and returns\n * the response\n *\n * @param {FetchEvent} event the fetch event of the triggered request\n * @param {{mapRequestToAsset: (string: Request) => Request, cacheControl: {bypassCache:boolean, edgeTTL: number, browserTTL:number}, ASSET_NAMESPACE: any, ASSET_MANIFEST:any}} [options] configurable options\n * @param {CacheControl} [options.cacheControl] determine how to cache on Cloudflare and the browser\n * @param {typeof(options.mapRequestToAsset)} [options.mapRequestToAsset]  maps the path of incoming request to the request pathKey to look up\n * @param {Object | string} [options.ASSET_NAMESPACE] the binding to the namespace that script references\n * @param {any} [options.ASSET_MANIFEST] the map of the key to cache and store in KV\n * */\n\ntype Evt = {\n\trequest: Request;\n\twaitUntil: (promise: Promise<unknown>) => void;\n};\n\nconst getAssetFromKV = async (\n\tevent: Evt,\n\toptions?: Partial<Options>\n): Promise<Response> => {\n\toptions = assignOptions(options);\n\n\tconst request = event.request;\n\tconst ASSET_NAMESPACE = options.ASSET_NAMESPACE;\n\tconst ASSET_MANIFEST = parseStringAsObject<AssetManifestType>(\n\t\toptions.ASSET_MANIFEST\n\t);\n\n\tif (typeof ASSET_NAMESPACE === \"undefined\") {\n\t\tthrow new InternalError(`there is no KV namespace bound to the script`);\n\t}\n\n\tconst rawPathKey = new URL(request.url).pathname.replace(/^\\/+/, \"\"); // strip any preceding /'s\n\tlet pathIsEncoded = options.pathIsEncoded;\n\tlet requestKey;\n\t// if options.mapRequestToAsset is explicitly passed in, always use it and assume user has own intentions\n\t// otherwise handle request as normal, with default mapRequestToAsset below\n\tif (options.mapRequestToAsset) {\n\t\trequestKey = options.mapRequestToAsset(request);\n\t} else if (ASSET_MANIFEST[rawPathKey]) {\n\t\trequestKey = request;\n\t} else if (ASSET_MANIFEST[decodeURIComponent(rawPathKey)]) {\n\t\tpathIsEncoded = true;\n\t\trequestKey = request;\n\t} else {\n\t\tconst mappedRequest = mapRequestToAsset(request);\n\t\tconst mappedRawPathKey = new URL(mappedRequest.url).pathname.replace(\n\t\t\t/^\\/+/,\n\t\t\t\"\"\n\t\t);\n\t\tif (ASSET_MANIFEST[decodeURIComponent(mappedRawPathKey)]) {\n\t\t\tpathIsEncoded = true;\n\t\t\trequestKey = mappedRequest;\n\t\t} else {\n\t\t\t// use default mapRequestToAsset\n\t\t\trequestKey = mapRequestToAsset(request, options);\n\t\t}\n\t}\n\n\tconst SUPPORTED_METHODS = [\"GET\", \"HEAD\"];\n\tif (!SUPPORTED_METHODS.includes(requestKey.method)) {\n\t\tthrow new MethodNotAllowedError(\n\t\t\t`${requestKey.method} is not a valid request method`\n\t\t);\n\t}\n\n\tconst parsedUrl = new URL(requestKey.url);\n\tconst pathname = pathIsEncoded\n\t\t? decodeURIComponent(parsedUrl.pathname)\n\t\t: parsedUrl.pathname; // decode percentage encoded path only when necessary\n\n\t// pathKey is the file path to look up in the manifest\n\tlet pathKey = pathname.replace(/^\\/+/, \"\"); // remove prepended /\n\n\t// @ts-expect-error we should pick cf types here\n\tconst cache = caches.default;\n\tlet mimeType = mime.getType(pathKey) || options.defaultMimeType;\n\tif (mimeType.startsWith(\"text\") || mimeType === \"application/javascript\") {\n\t\tmimeType += \"; charset=utf-8\";\n\t}\n\n\tlet shouldEdgeCache = false; // false if storing in KV by raw file path i.e. no hash\n\t// check manifest for map from file path to hash\n\tif (typeof ASSET_MANIFEST !== \"undefined\") {\n\t\tif (ASSET_MANIFEST[pathKey]) {\n\t\t\tpathKey = ASSET_MANIFEST[pathKey];\n\t\t\t// if path key is in asset manifest, we can assume it contains a content hash and can be cached\n\t\t\tshouldEdgeCache = true;\n\t\t}\n\t}\n\n\t// TODO this excludes search params from cache, investigate ideal behavior\n\tconst cacheKey = new Request(`${parsedUrl.origin}/${pathKey}`, request);\n\n\t// if argument passed in for cacheControl is a function then\n\t// evaluate that function. otherwise return the Object passed in\n\t// or default Object\n\tconst evalCacheOpts = (() => {\n\t\tswitch (typeof options.cacheControl) {\n\t\t\tcase \"function\":\n\t\t\t\treturn options.cacheControl(request);\n\t\t\tcase \"object\":\n\t\t\t\treturn options.cacheControl;\n\t\t\tdefault:\n\t\t\t\treturn defaultCacheControl;\n\t\t}\n\t})();\n\n\t// formats the etag depending on the response context. if the entityId\n\t// is invalid, returns an empty string (instead of null) to prevent the\n\t// the potentially disastrous scenario where the value of the Etag resp\n\t// header is \"null\". Could be modified in future to base64 encode etc\n\tconst formatETag = (\n\t\tentityId: string = pathKey,\n\t\tvalidatorType: string = options.defaultETag\n\t) => {\n\t\tif (!entityId) {\n\t\t\treturn \"\";\n\t\t}\n\t\tswitch (validatorType) {\n\t\t\tcase \"weak\":\n\t\t\t\tif (!entityId.startsWith(\"W/\")) {\n\t\t\t\t\tif (entityId.startsWith(`\"`) && entityId.endsWith(`\"`)) {\n\t\t\t\t\t\treturn `W/${entityId}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn `W/\"${entityId}\"`;\n\t\t\t\t}\n\t\t\t\treturn entityId;\n\t\t\tcase \"strong\":\n\t\t\t\tif (entityId.startsWith(`W/\"`)) {\n\t\t\t\t\tentityId = entityId.replace(\"W/\", \"\");\n\t\t\t\t}\n\t\t\t\tif (!entityId.endsWith(`\"`)) {\n\t\t\t\t\tentityId = `\"${entityId}\"`;\n\t\t\t\t}\n\t\t\t\treturn entityId;\n\t\t\tdefault:\n\t\t\t\treturn \"\";\n\t\t}\n\t};\n\n\toptions.cacheControl = Object.assign({}, defaultCacheControl, evalCacheOpts);\n\n\t// override shouldEdgeCache if options say to bypassCache\n\tif (\n\t\toptions.cacheControl.bypassCache ||\n\t\toptions.cacheControl.edgeTTL === null ||\n\t\trequest.method == \"HEAD\"\n\t) {\n\t\tshouldEdgeCache = false;\n\t}\n\t// only set max-age if explicitly passed in a number as an arg\n\tconst shouldSetBrowserCache =\n\t\ttypeof options.cacheControl.browserTTL === \"number\";\n\n\tlet response = null;\n\tif (shouldEdgeCache) {\n\t\tresponse = await cache.match(cacheKey);\n\t}\n\n\tif (response) {\n\t\tif (response.status > 300 && response.status < 400) {\n\t\t\tif (response.body && \"cancel\" in Object.getPrototypeOf(response.body)) {\n\t\t\t\t// Body exists and environment supports readable streams\n\t\t\t\tresponse.body.cancel();\n\t\t\t} else {\n\t\t\t\t// Environment doesnt support readable streams, or null repsonse body. Nothing to do\n\t\t\t}\n\t\t\tresponse = new Response(null, response);\n\t\t} else {\n\t\t\t// fixes #165\n\t\t\tconst opts = {\n\t\t\t\theaders: new Headers(response.headers),\n\t\t\t\tstatus: 0,\n\t\t\t\tstatusText: \"\",\n\t\t\t};\n\n\t\t\topts.headers.set(\"cf-cache-status\", \"HIT\");\n\n\t\t\tif (response.status) {\n\t\t\t\topts.status = response.status;\n\t\t\t\topts.statusText = response.statusText;\n\t\t\t} else if (opts.headers.has(\"Content-Range\")) {\n\t\t\t\topts.status = 206;\n\t\t\t\topts.statusText = \"Partial Content\";\n\t\t\t} else {\n\t\t\t\topts.status = 200;\n\t\t\t\topts.statusText = \"OK\";\n\t\t\t}\n\t\t\tresponse = new Response(response.body, opts);\n\t\t}\n\t} else {\n\t\tconst body = await ASSET_NAMESPACE.get(pathKey, \"arrayBuffer\");\n\t\tif (body === null) {\n\t\t\tthrow new NotFoundError(\n\t\t\t\t`could not find ${pathKey} in your content namespace`\n\t\t\t);\n\t\t}\n\t\tresponse = new Response(body);\n\n\t\tif (shouldEdgeCache) {\n\t\t\tresponse.headers.set(\"Accept-Ranges\", \"bytes\");\n\t\t\tresponse.headers.set(\"Content-Length\", String(body.byteLength));\n\t\t\t// set etag before cache insertion\n\t\t\tif (!response.headers.has(\"etag\")) {\n\t\t\t\tresponse.headers.set(\"etag\", formatETag(pathKey));\n\t\t\t}\n\t\t\t// determine Cloudflare cache behavior\n\t\t\tresponse.headers.set(\n\t\t\t\t\"Cache-Control\",\n\t\t\t\t`max-age=${options.cacheControl.edgeTTL}`\n\t\t\t);\n\t\t\tevent.waitUntil(cache.put(cacheKey, response.clone()));\n\t\t\tresponse.headers.set(\"CF-Cache-Status\", \"MISS\");\n\t\t}\n\t}\n\tresponse.headers.set(\"Content-Type\", mimeType);\n\n\tif (response.status === 304) {\n\t\tconst etag = formatETag(response.headers.get(\"etag\"));\n\t\tconst ifNoneMatch = cacheKey.headers.get(\"if-none-match\");\n\t\tconst proxyCacheStatus = response.headers.get(\"CF-Cache-Status\");\n\t\tif (etag) {\n\t\t\tif (ifNoneMatch && ifNoneMatch === etag && proxyCacheStatus === \"MISS\") {\n\t\t\t\tresponse.headers.set(\"CF-Cache-Status\", \"EXPIRED\");\n\t\t\t} else {\n\t\t\t\tresponse.headers.set(\"CF-Cache-Status\", \"REVALIDATED\");\n\t\t\t}\n\t\t\tresponse.headers.set(\"etag\", formatETag(etag, \"weak\"));\n\t\t}\n\t}\n\tif (shouldSetBrowserCache) {\n\t\tresponse.headers.set(\n\t\t\t\"Cache-Control\",\n\t\t\t`max-age=${options.cacheControl.browserTTL}`\n\t\t);\n\t} else {\n\t\tresponse.headers.delete(\"Cache-Control\");\n\t}\n\treturn response;\n};\n\nexport { getAssetFromKV, mapRequestToAsset, serveSinglePageApp };\nexport {\n\tOptions,\n\tCacheControl,\n\tMethodNotAllowedError,\n\tNotFoundError,\n\tInternalError,\n};\n"]}